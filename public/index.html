<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÿØŸÑŸäŸÑ ÿßŸÑŸÑŸäÿ±ÿ© - ÿßŸÑŸÖÿ≠ŸàŸÑ ÿßŸÑÿ∞ŸÉŸä</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        * { font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { 
            background-color: var(--tg-theme-bg-color, #f8fafc); 
            color: var(--tg-theme-text-color, #0f172a); 
            margin: 0; padding: 0; 
            touch-action: manipulation;
        }
        .tg-card { background: var(--tg-theme-secondary-bg-color, white); border-radius: 24px; }
        .tg-button { background-color: var(--tg-theme-button-color, #4f46e5); color: var(--tg-theme-button-text-color, white); }
        .input-field { font-size: 3.5rem; font-weight: 900; width: 100%; background: transparent; border: none; outline: none; }
        .grid-currencies { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    </style>
</head>
<body onscroll="document.activeElement.blur()">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const RATE = 100;
        const DENOMS_NEW = [
            { v: 500, s: 'üåæ', n: { ar: 'ÿ≥ŸÜÿßÿ®ŸÑ', en: 'Wheat' } },
            { v: 200, s: 'ü´í', n: { ar: 'ÿ≤Ÿäÿ™ŸàŸÜ', en: 'Olive' } },
            { v: 100, s: '‚òÅÔ∏è', n: { ar: 'ŸÇÿ∑ŸÜ', en: 'Cotton' } },
            { v: 50, s: 'üçä', n: { ar: 'ÿ≠ŸÖÿ∂Ÿäÿßÿ™', en: 'Citrus' } },
            { v: 25, s: 'üçá', n: { ar: 'ÿπŸÜÿ®', en: 'Grapes' } },
            { v: 10, s: 'üåº', n: { ar: 'Ÿäÿßÿ≥ŸÖŸäŸÜ', en: 'Jasmine' } }
        ];

        const DENOMS_OLD = [
            { v: 5000, s: 'üí∂', n: { ar: 'ÿÆŸÖÿ≥ÿ© ÿ¢ŸÑÿßŸÅ', en: '5000' } },
            { v: 2000, s: 'üí∂', n: { ar: 'ÿ£ŸÑŸÅŸäŸÜ', en: '2000' } },
            { v: 1000, s: 'üíµ', n: { ar: 'ÿ£ŸÑŸÅ', en: '1000' } },
            { v: 500, s: 'üíµ', n: { ar: 'ÿÆŸÖÿ≥ŸÖÿ¶ÿ©', en: '500' } }
        ];

        const FLAG_BY_CODE = { USD: "üá∫üá∏", AED: "üá¶üá™", SAR: "üá∏üá¶", EUR: "üá™üá∫", KWD: "üá∞üáº", SEK: "üá∏üá™", GBP: "üá¨üáß", JOD: "üáØüá¥" };
        const ORDERED_CODES = ["USD", "AED", "SAR", "EUR", "KWD", "SEK", "GBP", "JOD"];

        const TEXTS = {
            ar: {
                title: "ÿØŸÑŸäŸÑ ÿßŸÑŸÑŸäÿ±ÿ©",
                old: "ŸÇÿØŸäŸÖ", new: "ÿ¨ÿØŸäÿØ",
                inputLabel: (m) => `ÿßŸÑŸÖÿ®ŸÑÿ∫ (${m === 'oldToNew' ? 'ŸÑ.ÿ≥ ŸÇÿØŸäŸÖÿ©' : 'ŸÑŸäÿ±ÿ© ÿ¨ÿØŸäÿØÿ©'})`,
                resultLabel: (m) => `ÿßŸÑŸÖÿπÿßÿØŸÑ (${m === 'oldToNew' ? 'ÿ¨ÿØŸäÿØ' : 'ŸÇÿØŸäŸÖ'})`,
                fxTitle: "ÿ™ÿ≠ŸàŸäŸÑ ŸÑŸÑÿπŸÖŸÑÿßÿ™ ÿßŸÑÿ£ÿ¨ŸÜÿ®Ÿäÿ©",
                breakdownTitle: "ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑŸÅÿ¶ÿßÿ™ ÿßŸÑŸÜŸÇÿØŸäÿ©",
                leftoverMsg: (v, p) => `ÿ®ŸÇŸä ${v} ŸÑŸäÿ±ÿ© ÿ¨ÿØŸäÿØÿ©ÿå ÿ™ÿØŸÅÿπ ÿ®ŸÇŸäŸÖÿ© ${p} ŸÑ.ÿ≥ ŸÇÿØŸäŸÖÿ©.`,
                leftoverMsgOld: (v, p) => `ÿ®ŸÇŸä ${v} ŸÑ.ÿ≥ ŸÇÿØŸäŸÖÿ©ÿå ÿ™ÿØŸÅÿπ ÿ®ŸÇŸäŸÖÿ© ${p} ŸÑŸäÿ±ÿ© ÿ¨ÿØŸäÿØÿ©.`
            },
            en: {
                title: "Lira Guide",
                old: "Old", new: "New",
                inputLabel: (m) => `Amount (${m === 'oldToNew' ? 'Old SYP' : 'New Lira'})`,
                resultLabel: (m) => `Equivalent (${m === 'oldToNew' ? 'New' : 'Old'})`,
                fxTitle: "Currency Conversion",
                breakdownTitle: "Banknote Breakdown",
                leftoverMsg: (v, p) => `Remaining ${v} New Lira, pay as ${p} Old SYP.`,
                leftoverMsgOld: (v, p) => `Remaining ${v} Old SYP, pay as ${p} New Lira.`
            }
        };

        function App() {
            const [val, setVal] = useState('');
            const [mode, setMode] = useState('oldToNew');
            // ÿ™ŸÖ ÿ∂ÿ®ÿ∑ ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ÿπŸÑŸâ ÿßŸÑÿπÿ±ÿ®Ÿäÿ© 'ar' ŸÖÿ®ÿßÿ¥ÿ±ÿ©
            const [lang, setLang] = useState('ar');
            const [rates, setRates] = useState({});
            const inputRef = useRef(null);

            useEffect(() => {
                const tg = window.Telegram?.WebApp;
                if (tg) {
                    tg.ready();
                    tg.expand();
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿ¥ÿ±ÿ∑ ÿßŸÑÿ™ŸÜÿ®ÿ§ ÿ®ŸÑÿ∫ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸÜ ÿ™ŸÑÿ∫ÿ±ÿßŸÖ ŸÑÿ•ÿ®ŸÇÿßÿ° ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ŸÉÿ£ÿ≥ÿßÿ≥Ÿäÿ©
                }

                fetch("https://raw.githubusercontent.com/laithi/lira-telegram-bot/main/rates.json")
                    .then(res => res.json())
                    .then(data => { if(data.rates) setRates(data.rates); })
                    .catch(() => {});
            }, []);

            const t = TEXTS[lang];
            const isAr = lang === 'ar';

            const cleanInput = (txt) => {
                const normalized = txt.replace(/[Ÿ†-Ÿ©]/g, d => "0123456789"["Ÿ†Ÿ°Ÿ¢Ÿ£Ÿ§Ÿ•Ÿ¶ŸßŸ®Ÿ©".indexOf(d)] || d);
                return normalized.replace(/[^0-9.]/g, '');
            };

            const num = parseFloat(cleanInput(val)) || 0;
            const convertedVal = mode === 'oldToNew' ? (num / RATE) : (num * RATE);
            const liraNewBase = mode === 'oldToNew' ? convertedVal : num;

            const breakdown = useMemo(() => {
                let current = mode === 'oldToNew' ? convertedVal : num;
                const denoms = mode === 'oldToNew' ? DENOMS_NEW : DENOMS_OLD;
                const res = [];
                if (current > 0) {
                    denoms.forEach(d => {
                        const count = Math.floor(current / d.v);
                        if (count > 0) {
                            res.push({ ...d, count });
                            current = Math.round((current - count * d.v) * 100) / 100;
                        }
                    });
                }
                return { list: res, rem: current };
            }, [num, mode, convertedVal]);

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    inputRef.current.blur();
                }
            };

            const handleOutsideClick = () => {
                if (document.activeElement === inputRef.current) {
                    inputRef.current.blur();
                }
            };

            return (
                <div 
                    className={`max-w-md mx-auto p-4 space-y-6 ${isAr ? 'rtl' : 'ltr'}`}
                    onClick={handleOutsideClick}
                >
                    {/* Header */}
                    <div className="flex justify-between items-center" onClick={(e) => e.stopPropagation()}>
                        <div className="font-black text-2xl text-indigo-600">{t.title}</div>
                        <div className="flex gap-2">
                            <button onClick={() => setLang(lang === 'ar' ? 'en' : 'ar')} className="bg-black/5 px-3 py-1 rounded-xl text-[10px] font-bold">
                                {lang === 'ar' ? 'English' : 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©'}
                            </button>
                            <div className="bg-black/5 p-1 rounded-2xl flex">
                                <button onClick={() => setMode('oldToNew')} className={`px-3 py-1 rounded-xl text-[10px] font-bold transition-all ${mode === 'oldToNew' ? 'tg-button shadow-md' : 'opacity-40'}`}>{t.old}</button>
                                <button onClick={() => setMode('newToOld')} className={`px-3 py-1 rounded-xl text-[10px] font-bold transition-all ${mode === 'newToOld' ? 'tg-button shadow-md' : 'opacity-40'}`}>{t.new}</button>
                            </div>
                        </div>
                    </div>

                    {/* Input Card */}
                    <div className="tg-card p-6 shadow-sm border border-black/5" onClick={(e) => e.stopPropagation()}>
                        <div className="text-[10px] font-black opacity-30 uppercase mb-2">{t.inputLabel(mode)}</div>
                        <input 
                            ref={inputRef}
                            type="text" 
                            inputMode="decimal" 
                            value={val}
                            onChange={(e) => setVal(e.target.value)}
                            onKeyDown={handleKeyDown}
                            placeholder="0.00" 
                            className="input-field text-indigo-900"
                        />
                        <div className="mt-6 pt-5 border-t border-black/5">
                            <div className="text-[10px] font-black opacity-30 uppercase mb-1">{t.resultLabel(mode)}</div>
                            <div className="text-4xl font-black text-indigo-600">
                                {convertedVal.toLocaleString(isAr ? 'ar-SY' : 'en-US', { maximumFractionDigits: 2 })}
                            </div>
                        </div>
                    </div>

                    {/* 1. Remainder/Change Note (Immediate Priority) */}
                    {breakdown.rem > 0 && (
                        <div className="p-4 bg-amber-50 rounded-2xl border border-amber-100 flex gap-3 items-start animate-pulse">
                            <span className="text-xl">‚ö†Ô∏è</span>
                            <div className="text-amber-900 text-[11px] font-bold leading-relaxed">
                                {mode === 'oldToNew' 
                                    ? t.leftoverMsg(breakdown.rem, Math.round(breakdown.rem * RATE).toLocaleString())
                                    : t.leftoverMsgOld(breakdown.rem, (breakdown.rem / RATE).toFixed(2))
                                }
                            </div>
                        </div>
                    )}

                    {/* 2. Breakdown List */}
                    <div className="space-y-3">
                        <h3 className="text-[10px] font-black opacity-30 px-2 uppercase tracking-widest">{t.breakdownTitle}</h3>
                        <div className="space-y-2">
                            {breakdown.list.length > 0 ? breakdown.list.map(b => (
                                <div key={b.v} className="tg-card p-4 flex items-center justify-between border border-black/5 shadow-sm">
                                    <div className="flex items-center gap-4">
                                        <span className="text-3xl">{b.s}</span>
                                        <div>
                                            <div className="font-black text-xl leading-none">{b.v}</div>
                                            <div className="text-[9px] font-bold opacity-40 mt-1">{b.n[lang]}</div>
                                        </div>
                                    </div>
                                    <div className="tg-button px-4 py-1.5 rounded-xl font-black text-lg">√ó {b.count}</div>
                                </div>
                            )) : (
                                <div className="text-center py-4 text-slate-300 font-bold text-xs italic opacity-50">ÿ£ÿØÿÆŸÑ ŸÖÿ®ŸÑÿ∫ÿßŸã ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ..</div>
                            )}
                        </div>
                    </div>

                    {/* 3. FX Conversion Result */}
                    <div className="space-y-3 pb-10">
                        <h3 className="text-[10px] font-black opacity-30 px-2 uppercase tracking-widest">{t.fxTitle}</h3>
                        <div className="grid-currencies">
                            {ORDERED_CODES.map(code => {
                                const rate = rates[code]?.mid;
                                const result = (rate && liraNewBase > 0) ? (liraNewBase / rate).toFixed(2) : "0.00";
                                return (
                                    <div key={code} className="tg-card p-4 flex flex-col justify-between h-24 border border-black/5 shadow-sm">
                                        <div className="flex justify-between items-center">
                                            <span className="text-xs font-black opacity-30">{code}</span>
                                            <span>{FLAG_BY_CODE[code]}</span>
                                        </div>
                                        <div className="text-xl font-black text-indigo-600 font-mono">{result}</div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
